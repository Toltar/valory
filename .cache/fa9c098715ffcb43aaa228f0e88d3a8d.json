{"id":"9tIP","dependencies":[{"name":"/home/john/workspace/Valory2/tsconfig.json","includedInParent":true,"mtime":1531152310742},{"name":"/home/john/workspace/Valory2/package.json","includedInParent":true,"mtime":1533664046105},{"name":"/home/john/workspace/Valory2/.babelrc","includedInParent":true,"mtime":1533664058125},{"name":"../compiler/loader","loc":{"line":5,"column":25},"parent":"/home/john/workspace/Valory2/src/server/valory.ts","resolved":"/home/john/workspace/Valory2/src/compiler/loader.ts"},{"name":"./request","loc":{"line":7,"column":26},"parent":"/home/john/workspace/Valory2/src/server/valory.ts","resolved":"/home/john/workspace/Valory2/src/server/request.ts"},{"name":"../lib/config","loc":{"line":8,"column":25},"parent":"/home/john/workspace/Valory2/src/server/valory.ts","resolved":"/home/john/workspace/Valory2/src/lib/config.ts"},{"name":"../lib/defaultAdaptor","loc":{"line":9,"column":33},"parent":"/home/john/workspace/Valory2/src/server/valory.ts","resolved":"/home/john/workspace/Valory2/src/lib/defaultAdaptor.ts"},{"name":"./valoryheaders","loc":{"line":10,"column":32},"parent":"/home/john/workspace/Valory2/src/server/valory.ts","resolved":"/home/john/workspace/Valory2/src/server/valoryheaders.ts"}],"generated":{"js":"var $tIP$exports={};$parcel$require(\"9tIP\",\"bluebird\"),$parcel$require(\"9tIP\",\"bluebird\"),Object.defineProperty($tIP$exports,\"__esModule\",{value:!0}),$parcel$global.Promise=require(\"bluebird\");const $tIP$var$lodash_1=require(\"lodash\"),$tIP$var$loader_1=$parcel$require(\"9tIP\",\"../compiler/loader\"),$tIP$var$fs_1=require(\"fs\"),$tIP$var$request_1=$parcel$require(\"9tIP\",\"./request\"),$tIP$var$config_1=$parcel$require(\"9tIP\",\"../lib/config\"),$tIP$var$defaultAdaptor_1=$parcel$require(\"9tIP\",\"../lib/defaultAdaptor\"),$tIP$var$valoryheaders_1=$parcel$require(\"9tIP\",\"./valoryheaders\"),$tIP$var$P=require(\"pino\"),$tIP$var$pathMod=require(\"path\"),$tIP$var$steed=require(\"steed\")(),$tIP$var$uuid=require(\"hyperid\")(),$tIP$var$ERRORTABLEHEADER=\"|Status Code|Name|Description|\\n|-|-|--|\\n\",$tIP$var$REDOCPATH=\"../../html/index.html\",$tIP$var$DefaultErrorFormatter=(e,t)=>({statusCode:e.statusCode,body:{code:e.errorCode,message:null!=t?t:e.defaultMessage},headers:{\"Content-Type\":\"application/json\"}}),$tIP$var$DefaultErrors={ValidationError:{statusCode:200,errorCode:1001,defaultMessage:\"Invalid Parameters\"},TokenMalformed:{statusCode:200,errorCode:1002,defaultMessage:\"Authorization Failure\"},InternalError:{statusCode:200,errorCode:1003,defaultMessage:\"An internal error occured\"}};class $tIP$var$Valory{constructor(e,t,r=[],a=[],o,s,i,n,l={},$={}){if(this.server=i,this.Logger=$tIP$var$P({level:process.env[$tIP$var$valoryheaders_1.VALORYLOGGERVAR]||\"info\",prettyPrint:\"true\"===process.env[$tIP$var$valoryheaders_1.VALORYPRETTYLOGGERVAR]}),this.COMPILERMODE=\"TRUE\"===process.env.VALORYCOMPILER,this.TESTMODE=\"TRUE\"===process.env.TEST_MODE,this.errorFormatter=$tIP$var$DefaultErrorFormatter,this.globalMiddleware=[],this.globalPostMiddleware=[],this.errors=$tIP$var$DefaultErrors,this.metadata={undocumentedEndpoints:[],valoryPath:__dirname,compiledSwaggerPath:$tIP$var$config_1.Config.CompSwagPath,swagger:null},$tIP$var$config_1.Config.load(),null!=Valory.instance)throw Error(\"Only a single valory instance is allowed\");if(Valory.directInstantiation)throw Error(\"Direct instantiation of valory is not allowed\");if(Valory.instance=this,this.apiDef={swagger:\"2.0\",info:e,paths:{},definitions:o,tags:s,consumes:r,produces:a,parameters:l,responses:$},null!=n&&(this.Logger.debug(\"Path prefix set:\",n),this.apiDef.basePath=n),Object.assign(this.errors,t),this.COMPILERMODE){if(this.Logger.debug(\"Starting in compiler mode\"),this.apiDef.tags.push($tIP$var$generateErrorTable(this.errors)),\"\"!==$tIP$var$config_1.Config.SourceRoutePath){const e=require($tIP$var$config_1.Config.SourceRoutePath);Object.assign(this.apiDef.definitions,e.definitions),this.registerGeneratedRoutes=e.register}}else{if(this.Logger.info(\"Starting valory\"),this.TESTMODE&&(this.server=new $tIP$var$defaultAdaptor_1.DefaultAdaptor),\"\"!==$tIP$var$config_1.Config.SourceRoutePath){const e=require($tIP$var$config_1.Config.GeneratedRoutePath);Object.assign(this.apiDef.definitions,e.definitions),this.registerGeneratedRoutes=e.register}this.validatorModule=$tIP$var$loader_1.loadModule(o),this.server.allowDocSite&&this.registerDocSite()}}static createInstance(e){return Valory.directInstantiation=!1,new Valory(e.info,e.errors||{},e.consumes,e.produces,e.definitions||{},e.tags||[],e.server,e.basePath,e.parameters,e.responses)}static getInstance(){if(null==Valory.instance)throw Error(\"Valory instance has not yet been created\");return Valory.instance}endpoint(e,t,r,a,o=[],s=!0,i=[]){const n=$tIP$var$valoryheaders_1.HttpMethod[t].toLowerCase();this.Logger.debug(`Registering endpoint ${this.apiDef.basePath||\"\"}${e}:${n}`),this.COMPILERMODE?this.endpointCompile(e,t,r,a,n,o,s,i):this.endpointRun(e,t,r,a,n,o,s,i)}setErrorFormatter(e){this.errorFormatter=e}buildError(e,t){const r=\"string\"==typeof e?this.errors[e]:e;if(null==r)throw Error(`Error definition \"${e}\" does not exist`);return this.errorFormatter(r,t)}buildSuccess(e,t={}){return null==t[\"Content-Type\"]&&(\"object\"==typeof e?t[\"Content-Type\"]=\"application/json\":\"string\"==typeof e&&(t[\"Content-Type\"]=\"text/plain\")),{body:e,headers:t,statusCode:200}}get(e,t,r,a=[],o=!0,s=[]){this.endpoint(e,$tIP$var$valoryheaders_1.HttpMethod.GET,t,r,a,o,s)}post(e,t,r,a=[],o=!0,s=[]){this.endpoint(e,$tIP$var$valoryheaders_1.HttpMethod.POST,t,r,a,o,s)}delete(e,t,r,a=[],o=!0,s=[]){this.endpoint(e,$tIP$var$valoryheaders_1.HttpMethod.DELETE,t,r,a,o,s)}head(e,t,r,a=[],o=!0,s=[]){this.endpoint(e,$tIP$var$valoryheaders_1.HttpMethod.HEAD,t,r,a,o,s)}patch(e,t,r,a=[],o=!0,s=[]){this.endpoint(e,$tIP$var$valoryheaders_1.HttpMethod.PATCH,t,r,a,o,s)}put(e,t,r,a=[],o=!0,s=[]){this.endpoint(e,$tIP$var$valoryheaders_1.HttpMethod.PUT,t,r,a,o,s)}addGlobalMiddleware(e){this.Logger.debug(\"Adding global middleware:\",e.name),this.globalMiddleware.push(e)}addGlobalPostMiddleware(e){this.Logger.debug(\"Adding global post middleware:\",e.name),this.globalPostMiddleware.push(e)}start(e){null!=this.registerGeneratedRoutes&&this.registerGeneratedRoutes(this),this.metadata.swagger=this.apiDef;const t=this.server.getExport(this.metadata,e);return this.COMPILERMODE&&(process.env[$tIP$var$valoryheaders_1.VALORYMETAVAR]=JSON.stringify(t)),this.COMPILERMODE||this.Logger.info(\"Valory startup complete\"),t}shutdown(){this.server.shutdown()}endpointCompile(e,t,r,a,o,s=[],i=!0,n=[]){i||this.metadata.undocumentedEndpoints.push(e);const l=this.globalMiddleware.concat(s,this.globalPostMiddleware,n);for(const e of l)if(null!=e.tag){e.tag instanceof Array||(e.tag=[e.tag]);for(const t of e.tag){let e=\"\";\"string\"==typeof t?e=t:(this.apiDef.tags.push(t),e=t.name),null==r.tags?r.tags=[e]:r.tags.push(e)}}r.tags=$tIP$var$lodash_1.uniq(r.tags),this.apiDef.tags=$tIP$var$lodash_1.uniq(this.apiDef.tags),$tIP$var$lodash_1.set(this.apiDef.paths,`${e}.${o}`,r)}endpointRun(e,t,r,a,o,s=[],i=!0,n=[]){var l=this;const $=this.validatorModule.getValidator(e,o);if(null!=this.apiDef.basePath&&(e=this.apiDef.basePath+e),null==$)throw Error(\"Compiled swagger is out of date. Please run valory cli\");const d=`${e}:${o}`,u=this.Logger.child({endpoint:d}),h=this.globalMiddleware.concat(s),p=this.globalPostMiddleware.concat(n),c=u.chindings,g=(P=$tIP$import$_coroutine(function*(e){const t=$tIP$var$uuid();e.putAttachment(Valory.RequestIDKey,t),u.chindings=`${c},\"requestId\":\"${t}\"`,u.debug(e,\"Received request\");try{const r=yield $tIP$import$_resolve($tIP$var$processMiddleware(h,e,u));if(null!=r)return r;const o=$(e);let s;if(!0!==o)s=l.buildError(\"ValidationError\",o);else try{s=yield $tIP$import$_resolve(a(e,u,{requestId:t}))}catch(e){\"ValoryEndpointError\"===e.name?s=l.buildError(e.valoryErrorCode,e.message||void 0):(u.error(\"Internal exception occurred while processing request\"),u.error(e),s=l.buildError(\"InternalError\"))}e.putAttachment(Valory.ValidationResultKey,o),e.putAttachment(Valory.ResponseKey,s);const i=yield $tIP$import$_resolve($tIP$var$processMiddleware(p,e,u));return null!=i?i:s}catch(e){return\"ValoryEndpointError\"===e.name?l.buildError(e.valoryErrorCode,e.message||void 0):(u.error(\"Internal exception occurred while processing request\"),u.error(e),l.buildError(\"InternalError\"))}}),function(e){return P.apply(this,arguments)});var P;this.server.register(e,t,g)}registerDocSite(){const e=this.apiDef.basePath||\"\";let t;const r=this.validatorModule.swaggerBlob;this.server.register(e+\"/swagger.json\",$tIP$var$valoryheaders_1.HttpMethod.GET,e=>({body:r,headers:{\"Content-Type\":\"text/plain\"},query:null,path:null,statusCode:200,formData:null})),this.server.register(\"\"!==e?e:\"/\",$tIP$var$valoryheaders_1.HttpMethod.GET,e=>(t||(t=$tIP$var$fs_1.readFileSync($tIP$var$pathMod.join(__dirname,$tIP$var$REDOCPATH),{encoding:\"utf8\"})),{body:t,headers:{\"Content-Type\":\"text/html\"},query:null,path:null,statusCode:200,formData:null}))}}$tIP$var$Valory.ValidationResultKey=$tIP$var$request_1.ApiRequest.createKey(),$tIP$var$Valory.RequestIDKey=$tIP$var$request_1.ApiRequest.createKey(),$tIP$var$Valory.ResponseKey=$tIP$var$request_1.ApiRequest.createKey(),$tIP$var$Valory.directInstantiation=!0;var $tIP$export$Valory=$tIP$var$Valory;function $tIP$var$processMiddleware(e,t,r){return new Promise(a=>{let o=null;$tIP$var$steed.eachSeries(e,(e,a)=>{const s=r.child({middleware:e.name});s.debug(\"Running Middleware\"),e.handler(t,s,e=>{if(null!=e)return o=e,void a(e);a()})},e=>{a(o)})})}function $tIP$var$generateErrorTable(e){const t={name:\"Errors\",description:\"\",externalDocs:null};let r=$tIP$var$ERRORTABLEHEADER;const a=Object.keys(e);a.sort((t,r)=>{const a=e[t].errorCode,o=e[r].errorCode;return a<o?-1:a===o?0:a>o?1:void 0});for(const t of a){const a=e[t];r+=\"|\"+a.errorCode+\"|\"+t+\"|\"+a.defaultMessage+\"|\\n\"}return t.description=r,$tIP$var$lodash_1.omitBy(t,$tIP$var$lodash_1.isNil)}$tIP$exports.Valory=$tIP$export$Valory;"},"hash":"1b4b7bf74e96acb022088806e8d304d3","cacheData":{"env":{},"imports":{"$tIP$import$_coroutine":["bluebird","coroutine"],"$tIP$import$_resolve":["bluebird","resolve"]},"exports":{"Valory":"$tIP$export$Valory"},"wildcards":[],"isCommonJS":true}}